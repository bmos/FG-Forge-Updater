# This workflow uses actions that are not certified by GitHub. They are provided
# by a third-party and are governed by separate terms of service, privacy
# policy, and support documentation.

name: Scorecard supply-chain security

on:
    branch_protection_rule: null
    schedule:
        - cron: '20 7 * * 2'
    push:
        branches:
            - 'main'
    pull_request:
        branches:
            - 'main'

permissions: read-all

jobs:
    analysis:
        name: Scorecard analysis
        runs-on: ubuntu-latest
        permissions:
            security-events: write
            id-token: write

        steps:
            - name: Harden runner
              uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
              with:
                  disable-sudo: true
                  egress-policy: block
                  allowed-endpoints: >
                      api.deps.dev:443
                      api.github.com:443
                      api.osv.dev:443
                      api.scorecard.dev:443
                      fulcio.sigstore.dev:443
                      github.com:443
                      oss-fuzz-build-logs.storage.googleapis.com:443
                      rekor.sigstore.dev:443
                      tuf-repo-cdn.sigstore.dev:443
                      www.bestpractices.dev:443

            - name: Checkout code
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
              with:
                  persist-credentials: false

            - name: Run analysis
              uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
              with:
                  results_file: results.sarif
                  results_format: sarif
                  publish_results: true

            - name: Upload to code-scanning
              uses: github/codeql-action/upload-sarif@3599b3baa15b485a2e49ef411a7a4bb2452e7f93 # v3.29.5
              with:
                  sarif_file: results.sarif
